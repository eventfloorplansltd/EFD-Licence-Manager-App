<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>EFD License Manager</title>
  <!-- 1. Load Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- 2. Load React & Babel -->
  <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <!-- 3. Load html2canvas (for the email report) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  
  <style>
    /* Simple body style */
    body {
      font-family: 'Inter', sans-serif;
    }
    /* Add a subtle fade-in for the loading state */
    #root {
      transition: opacity 0.3s ease-in;
    }
  </style>
</head>
<body class="bg-gray-100">
  <!-- This is where the React app will be rendered -->
  <div id="root">
    <!-- Simple loading spinner -->
    <div class="flex items-center justify-center min-h-screen">
      <div class="w-16 h-16 border-4 border-blue-600 border-dashed rounded-full animate-spin" role="status">
        <span class="sr-only">Loading...</span>
      </div>
    </div>
  </div>

  <!-- 4. This is your ENTIRE React application -->
  <script type="text/babel">
    // Make sure React and its hooks are available
    const { useState, useEffect, useRef } = React;

    // --- Helper Functions ---

    // Helper to format dates (e.g., "8th November 2025")
    const formatDate = (dateString) => {
      if (!dateString) return 'N/A';

      // Split the date string to handle it as UTC and prevent timezone shifts
      const parts = dateString.split('-');
      if (parts.length !== 3) return dateString; // Return original if format is unexpected
      
      const year = parseInt(parts[0], 10);
      const month = parseInt(parts[1], 10) - 1; // Month is 0-indexed in JS
      const day = parseInt(parts[2], 10);

      const date = new Date(Date.UTC(year, month, day));

      const getDayWithSuffix = (d) => {
        if (d > 3 && d < 21) return `${d}th`;
        switch (d % 10) {
          case 1: return `${d}st`;
          case 2: return `${d}nd`;
          case 3: return `${d}rd`;
          default: return `${d}th`;
        }
      };

      const dayWithSuffix = getDayWithSuffix(date.getUTCDate());
      const monthName = date.toLocaleString('en-US', { month: 'long', timeZone: 'UTC' });
      
      return `${dayWithSuffix} ${monthName} ${date.getUTCFullYear()}`;
    };

    // Helper to get a date in the future (for mock data)
    const getFutureDate = (days) => {
      const date = new Date();
      date.setDate(date.getDate() + days);
      return date.toISOString().split('T')[0];
    };

    // NEW: Helper to get a date 1 month from today
    const getOneMonthFromToday = () => {
      const date = new Date();
      date.setMonth(date.getMonth() + 1);
      return date.toISOString().split('T')[0];
    };
    
    // --- MOCK DATA FOR PREVIEW ENVIRONMENT ---
    const mockData = {
      companies: [
        { id: 1, name: 'Innovate Corp', onHold: false },
        { id: 2, name: 'Future Solutions', onHold: false },
        { id: 3, name: 'Synergy Systems', onHold: true }, // This company is on hold
        { id: 4, name: 'Apex Digital', onHold: false },
      ],
      users: [
        // Innovate Corp
        { id: 101, companyId: 1, name: 'Alice Johnson', email: 'alice@innovate.com', licenseType: 'Individual', licenseExpiry: getFutureDate(300) },
        { id: 102, companyId: 1, name: 'Bob Williams', email: 'bob@innovate.com', licenseType: 'Shared', licenseExpiry: getFutureDate(10) }, // Expires soon
        { id: 103, companyId: 1, name: 'Charlie Brown', email: 'charlie@innovate.com', licenseType: 'Individual', licenseExpiry: getFutureDate(-5) }, // Expired

        // Future Solutions
        { id: 201, companyId: 2, name: 'Diana Prince', email: 'diana@future.com', licenseType: 'Individual', licenseExpiry: getFutureDate(120) },
        { id: 202, companyId: 2, name: 'Ethan Hunt', email: 'ethan@future.com', licenseType: 'Individual', licenseExpiry: getFutureDate(90) },

        // Synergy Systems
        { id: 301, companyId: 3, name: 'Fiona Glenanne', email: 'fiona@synergy.com', licenseType: 'Shared', licenseExpiry: getFutureDate(200) },
        { id: 302, companyId: 3, name: 'George Costanza', email: 'george@synergy.com', licenseType: 'Shared', licenseExpiry: null }, // No expiry
      ],
      addons: [
        { id: 1, name: 'Premium Support' },
        { id: 2, name: 'Advanced Analytics' },
        { id: 3, name: 'Cloud Rendering Pack' },
      ],
      userAddons: [
        { id: 1, userId: 101, addonId: 1 },
        { id: 2, userId: 101, addonId: 2 },
        { id: 3, userId: 102, addonId: 1 },
        { id: 4, userId: 201, addonId: 3 },
        { id: 5, userId: 301, addonId: 1 },
        { id: 6, userId: 301, addonId: 3 },
      ],
    };


    // --- React Components ---

    /**
     * A reusable card component
     */
    function Card({ title, children }) {
      return (
        <div className="bg-white shadow-lg rounded-xl overflow-hidden mb-8">
          <div className="p-6">
            {title && <h2 className="text-2xl font-semibold text-gray-900 mb-4">{title}</h2>}
            {children}
          </div>
        </div>
      );
    }

    /**
     * A simple card to show a single statistic
     */
    function StatCard({ label, value }) {
      return (
        <div className="bg-white shadow-lg rounded-xl p-4 flex-1 min-w-[150px]">
          <h3 className="text-sm font-medium text-gray-500 truncate">{label}</h3>
          <p className="mt-1 text-3xl font-semibold text-gray-900">{value}</p>
        </div>
      );
    }

    /**
     * Helper component for styling license status
     */
    const getStatusChip = (expiry, company) => {
      // NEW: "On Hold" status takes priority
      if (company?.onHold) {
        return <span className="px-3 py-1 inline-flex text-xs leading-5 font-semibold rounded-full bg-purple-100 text-purple-800">On Hold</span>;
      }
      
      if (!expiry) {
         return <span className="px-3 py-1 inline-flex text-xs leading-5 font-semibold rounded-full bg-gray-100 text-gray-800">N/A</span>;
      }
      const daysLeft = (new Date(expiry) - new Date()) / (1000 * 60 * 60 * 24);
      
      if (daysLeft < 0) {
        return <span className="px-3 py-1 inline-flex text-xs leading-5 font-semibold rounded-full bg-red-100 text-red-800">Expired</span>;
      }
      if (daysLeft <= 14) {
        return <span className="px-3 py-1 inline-flex text-xs leading-5 font-semibold rounded-full bg-yellow-100 text-yellow-800">Expires Soon</span>;
      }
      // All other licenses are considered active
      return <span className="px-3 py-1 inline-flex text-xs leading-5 font-semibold rounded-full bg-blue-100 text-blue-800">Active</span>;
    };

    /**
     * A simple text-based status for the image report
     */
    const getStatusText = (expiry, company) => {
      // NEW: "On Hold" status takes priority
      if (company?.onHold) return 'On Hold';
      
      if (!expiry) return 'N/A';
      const daysLeft = (new Date(expiry) - new Date()) / (1000 * 60 * 60 * 24);
      if (daysLeft < 0) return 'Expired';
      if (daysLeft <= 14) return 'Expires Soon';
      return 'Active';
    };


    /**
     * Component for the main dashboard lozenge with new summary logic
     */
    function CompanyStatusLozenge({ company, users }) {
      // NEW: "On Hold" status takes priority
      if (company.onHold) {
        return (
          <div className="flex flex-wrap gap-2">
            <span className="px-3 py-1 inline-flex text-xs leading-5 font-semibold rounded-full bg-purple-100 text-purple-800">
              On Hold
            </span>
          </div>
        );
      }
      
      const companyUsers = users.filter(u => u.companyId === company.id);
      
      if (companyUsers.length === 0) {
        return <span className="px-3 py-1 inline-flex text-xs leading-5 font-semibold rounded-full bg-gray-100 text-gray-800">No Licenses</span>;
      }

      // Calculate counts for each status
      const now = new Date();
      let expiredCount = 0;
      let soonCount = 0;
      let activeCount = 0; 

      companyUsers.forEach(u => {
        if (!u.licenseExpiry) {
          activeCount++; // Count licenses with no expiry as active
          return;
        }
        const daysLeft = (new Date(u.licenseExpiry) - new Date()) / (1000 * 60 * 60 * 24);

        if (daysLeft < 0) {
          expiredCount++;
        } else if (daysLeft <= 14) {
          soonCount++;
        } else {
          activeCount++;
        }
      });

      return (
        <div className="flex flex-wrap gap-2">
          {expiredCount > 0 && (
            <span className="px-3 py-1 inline-flex text-xs leading-5 font-semibold rounded-full bg-red-100 text-red-800">
              {expiredCount} Expired
            </span>
          )}
          {soonCount > 0 && (
            <span className="px-3 py-1 inline-flex text-xs leading-5 font-semibold rounded-full bg-yellow-100 text-yellow-800">
              {soonCount} Expires Soon
            </span>
          )}
          {activeCount > 0 && (
            <span className="px-3 py-1 inline-flex text-xs leading-5 font-semibold rounded-full bg-blue-100 text-blue-800">
              {activeCount} Active
            </span>
          )}
        </div>
      );
    }


    /**
     * Page 1: Shows a list of all companies and their license counts
     */
    function CompaniesListPage({ 
      companies,
      setCompanies, 
      users,
      setUsers,
      setUserAddons,
      onSelectCompany, 
      totalLicenses, 
      totalIndividual,
      totalShared 
    }) {
      
      // State for search term
      const [searchTerm, setSearchTerm] = useState('');
      // State for sorting
      const [sortConfig, setSortConfig] = useState({ key: 'name', direction: 'ascending' });
      // State for Add Company modal
      const [isAddCompanyModalOpen, setIsAddCompanyModalOpen] = useState(false);
      // State for confirming company removal
      const [companyToConfirmRemove, setCompanyToConfirmRemove] = useState(null);
      
      const getLicenseCount = (companyId) => {
        return users.filter(u => u.companyId === companyId).length;
      };
      
      // Filter companies based on search
      const filteredCompanies = companies.filter(company =>
        company.name.toLowerCase().includes(searchTerm.toLowerCase())
      );
      
      // --- Sorting Logic ---
      
      const getSortableCompanyStatus = (company) => {
        // NEW: On Hold status is the highest priority
        if (company.onHold) return 0;

        const companyUsers = users.filter(u => u.companyId === company.id);
        if (companyUsers.length === 0) return 4; // No licenses, sort last

        const now = new Date();
        let worstStatus = 3; // Start with 'Active'

        for (const u of companyUsers) {
          if (!u.licenseExpiry) continue; // No expiry, remains 'Active'
          const daysLeft = (new Date(u.licenseExpiry) - new Date()) / (1000 * 60 * 60 * 24);

          if (daysLeft < 0) {
            return 1; // Expired is the worst, can return immediately
          }
          if (daysLeft <= 14) {
            worstStatus = 2; // 'Expires Soon' is worse than 'Active'
          }
        }
        return worstStatus; // Will be 1 (Expired), 2 (Expires Soon), or 3 (Active)
      };

      // Function to handle sort request
      const requestSort = (key) => {
        let direction = 'ascending';
        if (sortConfig.key === key && sortConfig.direction === 'ascending') {
          direction = 'descending';
        }
        setSortConfig({ key, direction });
      };
      
      // Apply sorting
      const sortedCompanies = [...filteredCompanies].sort((a, b) => {
        let aValue;
        let bValue;

        switch (sortConfig.key) {
          case 'name':
            aValue = a.name;
            bValue = b.name;
            break;
          case 'totalLicenses':
            aValue = getLicenseCount(a.id);
            bValue = getLicenseCount(b.id);
            break;
          case 'status':
            aValue = getSortableCompanyStatus(a);
            bValue = getSortableCompanyStatus(b);
            break;
          default:
            aValue = a.name;
            bValue = b.name;
        }

        // Perform comparison
        let comparison = 0;
        if (aValue > bValue) {
          comparison = 1;
        } else if (aValue < bValue) {
          comparison = -1;
        }

        // Apply direction
        return sortConfig.direction === 'ascending' ? comparison : -comparison;
      });

      // Helper to get sort icon
      const getSortIcon = (key) => {
        if (sortConfig.key !== key) {
          return null;
        }
        if (sortConfig.direction === 'ascending') {
          return ' \u25B2'; // Up arrow
        }
        return ' \u25BC'; // Down arrow
      };
      // --- End Sorting Logic ---
      
      // Handler for adding a company
      const handleAddCompany = (companyName) => {
        if (!companyName.trim()) return;
        
        // MOCK: Add to local state
        const newCompany = {
            id: Date.now(), // Use timestamp for unique ID in mock environment
            name: companyName.trim(),
            onHold: false, // New companies are not on hold
        };
        setCompanies(prev => [...prev, newCompany]);
        setIsAddCompanyModalOpen(false);
      };
      
      // Handler for removing a company and its data
      const executeRemoveCompany = (companyIdToRemove) => {
        const userIdsToRemove = users
          .filter(u => u.companyId === companyIdToRemove)
          .map(u => u.id);
        
        // Remove company, its users, and their addon assignments
        setCompanies(prev => prev.filter(c => c.id !== companyIdToRemove));
        setUsers(prev => prev.filter(u => u.companyId !== companyIdToRemove));
        setUserAddons(prev => prev.filter(ua => !userIdsToRemove.includes(ua.userId)));

        setCompanyToConfirmRemove(null);
      };
      
      // NEW: Handler to toggle the on-hold status of a company
      const handleToggleOnHold = (companyId) => {
        setCompanies(prevCompanies =>
          prevCompanies.map(c =>
            c.id === companyId ? { ...c, onHold: !c.onHold } : c
          )
        );
      };

      return (
        <>
          {/* Stats for the main dashboard */}
          <div className="mb-6 grid grid-cols-1 md:grid-cols-3 gap-4">
             <StatCard label="Total Licenses" value={totalLicenses} />
             <StatCard label="Individual" value={totalIndividual} />
             <StatCard label="Shared" value={totalShared} />
          </div>

          <Card title="Companies">
            {/* Search bar and Add button row */}
            <div className="flex flex-col md:flex-row gap-4 mb-4">
              <div className="relative flex-grow">
                <span className="absolute inset-y-0 left-0 flex items-center pl-3 text-gray-400">
                  <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}>
                    <path strokeLinecap="round" strokeLinejoin="round" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                  </svg>
                </span>
                <input
                  type="text"
                  value={searchTerm}
                  onChange={(e) => setSearchTerm(e.target.value)}
                  placeholder="Search by company name..."
                  className="block w-full rounded-full border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm pl-10 pr-10 py-2"
                />
                {searchTerm && (
                  <button
                    onClick={() => setSearchTerm('')}
                    className="absolute inset-y-0 right-0 flex items-center pr-2 focus:outline-none"
                    aria-label="Clear search"
                  >
                    <div className="bg-gray-200 hover:bg-gray-300 rounded-full p-1 transition-colors">
                      <svg xmlns="http://www.w3.org/2000/svg" className="h-4 w-4 text-gray-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}>
                        <path strokeLinecap="round" strokeLinejoin="round" d="M6 18L18 6M6 6l12 12" />
                      </svg>
                    </div>
                  </button>
                )}
              </div>
              {/* Add Company Button */}
              <div className="flex-shrink-0">
                <button
                  onClick={() => setIsAddCompanyModalOpen(true)}
                  className="w-full md:w-auto px-4 py-2 bg-blue-600 text-white rounded-full shadow-sm hover:bg-blue-700 transition-colors focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2"
                >
                  Add Company
                </button>
              </div>
            </div>
          
            <div className="overflow-x-auto">
              <table className="min-w-full divide-y divide-gray-200">
                <thead className="bg-gray-50">
                  <tr>
                    {/* Clickable Headers */}
                    <th 
                      className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100"
                      onClick={() => requestSort('name')}
                    >
                      Company Name{getSortIcon('name')}
                    </th>
                    <th 
                      className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100"
                      onClick={() => requestSort('totalLicenses')}
                    >
                      Total Licenses{getSortIcon('totalLicenses')}
                    </th>
                    <th 
                      className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100"
                      onClick={() => requestSort('status')}
                    >
                      License Status{getSortIcon('status')}
                    </th>
                    <th className="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Action</th>
                  </tr>
                </thead>
                <tbody className="bg-white divide-y divide-gray-200">
                  {/* Map over sorted companies */}
                  {sortedCompanies.length > 0 ? (
                    sortedCompanies.map((company) => (
                      <tr key={company.id} className={company.onHold ? 'bg-red-50' : ''}>
                        {/* UPDATED: Company name is now a button */}
                        <td className="px-6 py-4 whitespace-nowrap text-sm font-medium">
                          <button
                            onClick={() => onSelectCompany(company.id)}
                            className="text-gray-900 hover:text-blue-600 text-left focus:outline-none"
                          >
                            {company.name}
                          </button>
                        </td>
                        <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{getLicenseCount(company.id)}</td>
                        <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                          {/* UPDATED: Pass full company object */}
                          <CompanyStatusLozenge company={company} users={users} />
                        </td>
                        {/* UPDATED: Actions column has delete and on-hold buttons */}
                        <td className="px-6 py-4 whitespace-nowrap text-sm font-medium text-right">
                          <div className="flex items-center justify-end space-x-4">
                            {/* NEW: On Hold / Resume Button */}
                            <button
                              onClick={() => handleToggleOnHold(company.id)}
                              className="text-gray-500 hover:text-purple-600 focus:outline-none"
                              title={company.onHold ? "Resume Company" : "Put Company On Hold"}
                            >
                              {company.onHold ? (
                                <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                  <path fillRule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z" clipRule="evenodd" />
                                </svg>
                              ) : (
                                <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                  <path fillRule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zM7 8a1 1 0 012 0v4a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v4a1 1 0 102 0V8a1 1 0 00-1-1z" clipRule="evenodd" />
                                </svg>
                              )}
                            </button>
                            
                            {/* Remove Company Button */}
                            <button
                              onClick={() => setCompanyToConfirmRemove(company)}
                              className="text-gray-500 hover:text-red-600 focus:outline-none"
                              title="Remove company"
                            >
                              <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}>
                                <path strokeLinecap="round" strokeLinejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                              </svg>
                            </button>
                          </div>
                        </td>
                      </tr>
                    ))
                  ) : (
                    // No results message
                    <tr>
                      <td colSpan="4" className="px-6 py-4 text-center text-sm text-gray-500 italic">
                        {searchTerm ? `No companies found matching "${searchTerm}".` : 'No companies to display.'}
                      </td>
                    </tr>
                  )}
                </tbody>
              </table>
            </div>
          </Card>
          
          {/* Render Add Company Modal */}
          <AddCompanyModal
            isOpen={isAddCompanyModalOpen}
            onClose={() => setIsAddCompanyModalOpen(false)}
            onAddCompany={handleAddCompany}
          />
          
          {/* NEW: Render Confirm Remove Company Modal */}
          <ConfirmRemoveCompanyModal
            isOpen={!!companyToConfirmRemove}
            onClose={() => setCompanyToConfirmRemove(null)}
            company={companyToConfirmRemove}
            onConfirmRemove={executeRemoveCompany}
          />
        </>
      );
    }

    /**
     * Page 2: Shows a list of users for a specific company
     */
    function CompanyDetailPage({ 
      company, 
      users, setUsers, 
      addons, userAddons, setUserAddons, // Addon state
      onBack 
    }) {

      const [isReportModalOpen, setIsReportModalOpen] = useState(false);
      const [generatedImage, setGeneratedImage] = useState(null);
      const [isGenerating, setIsGenerating] = useState(false);
      const [userToConfirmRemove, setUserToConfirmRemove] = useState(null);
      const [managingUser, setManagingUser] = useState(null);
      const [editingUser, setEditingUser] = useState(null);
      const [copiedEmail, setCopiedEmail] = useState(null); // NEW: State for copy feedback
      
      // NEW: State for the combined Add modal
      const [isAddModalOpen, setIsAddModalOpen] = useState(false);
      
      // State for bulk date editing
      const [selectedUserIds, setSelectedUserIds] = useState(new Set());
      const [bulkDate, setBulkDate] = useState('');

      // All users for THIS company
      const usersForCompany = users.filter(u => u.companyId === company.id);
      
      // Get addons for a specific user
      const getAddonsForUser = (userId) => {
        return userAddons
          .filter(ua => ua.userId === userId)
          .map(ua => addons.find(a => a.id === ua.addonId))
          .filter(Boolean); // Filter out any potential undefined
      };
      
      // UPDATED: Calculate stats from users
      const companyTotal = usersForCompany.length;
      const individualCount = usersForCompany.filter(l => l.licenseType === 'Individual').length;
      const sharedCount = usersForCompany.filter(l => l.licenseType === 'Shared').length;

      // UPDATED: handleLicenseTypeChange now takes userId and removes addons if switched to 'Shared'
      const handleLicenseTypeChange = (userId, newType) => {
        const userToUpdate = users.find(u => u.id === userId);
        const updatedUser = { ...userToUpdate, licenseType: newType };
        
        // Optimistic UI Update for user's license type
        setUsers(prevUsers => 
          prevUsers.map(user => 
            user.id === userId ? updatedUser : user
          )
        );
        
        // NEW: If changing to 'Shared', remove all addons for that user.
        if (newType === 'Shared') {
          setUserAddons(prevUserAddons => 
            prevUserAddons.filter(ua => ua.userId !== userId)
          );
        }
        // MOCK: Removed API Call
      };
      
      // Handler for individual date change
      const handleDateChange = (userId, newDate) => {
        if (newDate) { // Only update if the date is valid
          const userToUpdate = users.find(u => u.id === userId);
          const updatedUser = { ...userToUpdate, licenseExpiry: newDate };

          // Optimistic UI Update
          setUsers(prevUsers => 
            prevUsers.map(user =>
              user.id === userId ? updatedUser : user
            )
          );
           // MOCK: Removed API Call
        }
      };

      const handleGenerateReportClick = () => {
        setGeneratedImage(null);
        setIsGenerating(true);
        setIsReportModalOpen(true);
      };

      // UPDATED: This function now also creates and assigns a license
      const handleAddNewUserWithLicense = ({ name, email, type, expiry }) => {
        if (!name || !email || !type || !expiry) {
          return; // Simple validation
        }
        
        // MOCK: Add to local state
        const newUser = {
            id: Date.now(),
            companyId: company.id,
            name,
            email,
            licenseType: type,
            licenseExpiry: expiry,
        };
        setUsers(prevUsers => [...prevUsers, newUser]);
        setIsAddModalOpen(false); // Close modal
      };
      
      const handleSaveUser = (updatedUser) => {
        // Optimistic UI Update
        setUsers(prevUsers => 
          prevUsers.map(user => 
            user.id === updatedUser.id ? updatedUser : user
          )
        );
        setEditingUser(null); // Close modal
        // MOCK: Removed API Call
      };
      
      // UPDATED: Simplified user removal
      const executeRemoveUser = (userIdToRemove) => {
        // Optimistic UI Update
        setUsers(prevUsers => prevUsers.filter(user => user.id !== userIdToRemove));
        // MOCK: Remove associated user addons
        setUserAddons(prev => prev.filter(ua => ua.userId !== userIdToRemove));
        setUserToConfirmRemove(null);
        // MOCK: Removed API Call
      };
      
      // --- NEW: Email Handlers ---
      const handleCopyEmail = (email) => {
        navigator.clipboard.writeText(email);
        setCopiedEmail(email);
        setTimeout(() => setCopiedEmail(null), 2000);
      };

      const handleEmailAll = () => {
        if (usersForCompany.length === 0) return;
        const bccList = usersForCompany.map(u => u.email).join(',');
        
        const gmailBaseUrl = 'https://mail.google.com/mail/?view=cm&fs=1&bcc=';
        const gmailLink = `${gmailBaseUrl}${encodeURIComponent(bccList)}`;

        // Most browsers have a URL limit around 2000 chars. Let's be safe.
        if (gmailLink.length > 2000) {
            alert('The list of users is too long to open in a single Gmail compose window. Please consider exporting the list and using a dedicated mailing tool.');
            return;
        }
        
        // Open in a new tab
        window.open(gmailLink, '_blank', 'noopener,noreferrer');
      };
      // --- End Email Handlers ---
      
      // --- Bulk Action Handlers ---
      const toggleSelectAll = (isChecked) => {
        if (isChecked) {
          // Select all users in the *current view* (usersForCompany)
          const allUserIds = usersForCompany.map(u => u.id);
          setSelectedUserIds(new Set(allUserIds));
        } else {
          setSelectedUserIds(new Set());
        }
      };
      
      const toggleUserSelection = (userId, isChecked) => {
        setSelectedUserIds(prev => {
          const newSet = new Set(prev);
          if (isChecked) {
            newSet.add(userId);
          } else {
            newSet.delete(userId);
          }
          return newSet;
        });
      };
      
      // UPDATED: Bulk expiry now updates users state
      const handleBulkSetExpiry = () => {
        if (!bulkDate) return; // Don't do anything if date is empty
        
        // Optimistic UI Update
        setUsers(prevUsers => 
          prevUsers.map(user => {
            // Find selected users
            if (selectedUserIds.has(user.id)) {
              return { ...user, licenseExpiry: bulkDate };
            }
            return user;
          })
        );
        
        // Clear selection and date
        setSelectedUserIds(new Set());
        setBulkDate('');
        // MOCK: Removed API Call
      };
      
      const isAllSelected = usersForCompany.length > 0 && selectedUserIds.size === usersForCompany.length;
      // --- End Bulk Action Handlers ---

      return (
        <>
          <Card>
            <div className="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
              <h2 className="text-2xl font-semibold text-gray-900">{company.name}</h2>
              <div className="flex flex-wrap gap-2">
                {/* UPDATED: Renamed button */}
                <button
                  onClick={() => setIsAddModalOpen(true)}
                  className="px-4 py-2 bg-purple-600 text-white rounded-md shadow-sm hover:bg-purple-700 transition-colors focus:outline-none focus:ring-2 focus:ring-purple-500 focus:ring-offset-2"
                >
                  Add User
                </button>
                {/* NEW: Email All Users Button */}
                <button
                  onClick={handleEmailAll}
                  disabled={usersForCompany.length === 0}
                  className="px-4 py-2 bg-blue-600 text-white rounded-md shadow-sm hover:bg-blue-700 transition-colors focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 disabled:bg-gray-400 disabled:cursor-not-allowed"
                  title={usersForCompany.length > 0 ? `Email all ${usersForCompany.length} users in this company` : 'No users to email'}
                >
                  Email All Users
                </button>
                <button
                  onClick={handleGenerateReportClick}
                  className="px-4 py-2 bg-green-600 text-white rounded-md shadow-sm hover:bg-green-700 transition-colors focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2"
                >
                  Generate Email Report
                </button>
                <button
                  onClick={onBack}
                  className="px-4 py-2 bg-gray-200 text-gray-800 rounded-md shadow-sm hover:bg-gray-300 transition-colors focus:outline-none focus:ring-2 focus:ring-gray-400 focus:ring-offset-2"
                >
                  &larr; Back to Companies
                </button>
              </div>
            </div>

            {/* Stats for this specific company */}
            <div className="mb-6 grid grid-cols-1 md:grid-cols-3 gap-4">
              <StatCard label="Total Licenses" value={companyTotal} />
              <StatCard label="Individual" value={individualCount} />
              <StatCard label="Shared" value={sharedCount} />
            </div>

            {/* This table now iterates over users, which is correct */}
            <h3 className="text-xl font-semibold text-gray-800 mb-4">Users & Assigned Licenses</h3>
            
            {/* NEW: Bulk Action Bar */}
            {selectedUserIds.size > 0 && (
              <div className="bg-gray-100 p-4 rounded-lg mb-4 flex flex-col md:flex-row items-center gap-4">
                <span className="font-medium text-sm text-gray-700">
                  {selectedUserIds.size} {selectedUserIds.size === 1 ? 'user' : 'users'} selected
                </span>
                <div className="flex-grow flex items-center gap-2">
                  <input
                    type="date"
                    value={bulkDate}
                    onChange={(e) => setBulkDate(e.target.value)}
                    className="block w-full max-w-xs rounded-md border border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm py-2 px-3"
                  />
                  <button
                    onClick={handleBulkSetExpiry}
                    disabled={!bulkDate}
                    className="px-4 py-2 bg-blue-600 text-white rounded-md shadow-sm hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 disabled:bg-gray-400"
                  >
                    Set Expiry
                  </button>
                </div>
              </div>
            )}
            
            <div className="overflow-x-auto">
              <table className="min-w-full divide-y divide-gray-200">
                <thead className="bg-gray-50">
                  <tr>
                    {/* NEW: Select All Checkbox */}
                    <th className="p-4">
                      <input
                        type="checkbox"
                        className="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500"
                        checked={isAllSelected}
                        onChange={(e) => toggleSelectAll(e.target.checked)}
                      />
                    </th>
                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Name</th>
                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Email</th>
                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">License Type</th>
                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Expires</th>
                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Addons</th>
                    <th className="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                  </tr>
                </thead>
                <tbody className="bg-white divide-y divide-gray-200">
                  {usersForCompany.length > 0 ? usersForCompany.map((user) => {
                    const userAddonsList = getAddonsForUser(user.id);
                    const isSelected = selectedUserIds.has(user.id);
                    
                    return (
                      <tr key={user.id} className={isSelected ? 'bg-blue-50' : company.onHold ? 'bg-red-50' : ''}>
                        {/* NEW: Row Checkbox */}
                        <td className="p-4">
                          <input
                            type="checkbox"
                            className="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500"
                            checked={isSelected}
                            onChange={(e) => toggleUserSelection(user.id, e.target.checked)}
                          />
                        </td>
                        <td className="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">{user.name}</td>
                        {/* UPDATED: Interactive Email Cell */}
                        <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                          <div className="flex items-center space-x-2 group">
                            <a 
                              href={`https://mail.google.com/mail/?view=cm&fs=1&to=${user.email}`} 
                              target="_blank"
                              rel="noopener noreferrer"
                              className="hover:text-blue-600" 
                              title={`Email ${user.email} using Gmail`}
                            >
                              {user.email}
                            </a>
                            <div className="relative">
                              <button
                                onClick={() => handleCopyEmail(user.email)}
                                className="text-gray-400 hover:text-gray-700 opacity-0 group-hover:opacity-100 focus:opacity-100 transition-opacity"
                                aria-label="Copy email address"
                              >
                                <svg xmlns="http://www.w3.org/2000/svg" className="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}>
                                  <path strokeLinecap="round" strokeLinejoin="round" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" />
                                </svg>
                              </button>
                              {copiedEmail === user.email && (
                                <div className="absolute z-10 -top-8 left-1/2 -translate-x-1/2 px-2 py-1 bg-gray-800 text-white text-xs rounded-md shadow-lg">
                                  Copied!
                                </div>
                              )}
                            </div>
                          </div>
                        </td>
                        <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                          {/* UPDATED: Read from user object */}
                          <select
                            value={user.licenseType}
                            onChange={(e) => handleLicenseTypeChange(user.id, e.target.value)}
                            className="block w-full max-w-[120px] rounded-md border border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm py-2"
                          >
                            <option>Individual</option>
                            <option>Shared</option>
                          </select>
                        </td>
                        <td className="px-6 py-4 whitespace-nowrap text-sm">
                          {/* UPDATED: Pass company object to get correct status */}
                          {getStatusChip(user.licenseExpiry, company)}
                        </td>
                        
                        {/* UPDATED: Expires column is now an input */}
                        <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                          <input
                            type="date"
                            value={user.licenseExpiry || ''}
                            onChange={(e) => handleDateChange(user.id, e.target.value)}
                            className="block w-full max-w-[150px] rounded-md border border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm py-2"
                          />
                        </td>
                        
                        {/* Addons Cell (UPDATED) */}
                        <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                          {user.licenseType === 'Shared' ? (
                            <span className="text-gray-400 italic" title="Addons are not available for Shared licenses.">
                              N/A
                            </span>
                          ) : (
                            <button
                              onClick={() => setManagingUser(user)}
                              className="text-left focus:outline-none"
                              title="Manage addons for this user"
                            >
                              {userAddonsList.length > 0 ? (
                                <ul className="list-disc list-inside text-blue-600 hover:text-blue-800">
                                  {userAddonsList.map(addon => <li key={addon.id} className="truncate">{addon.name}</li>)}
                                </ul>
                              ) : (
                                <span className="text-gray-400 italic hover:text-gray-600">None (Manage)</span>
                              )}
                            </button>
                          )}
                        </td>
                        
                        {/* Actions Cell (Restored) */}
                        <td className="px-6 py-4 whitespace-nowrap text-sm font-medium text-right">
                          <div className="flex items-center justify-end space-x-3">
                            {/* Edit Button */}
                            <button
                              onClick={() => setEditingUser(user)}
                              className="text-gray-500 hover:text-blue-600 focus:outline-none"
                              title="Edit user"
                            >
                              <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}>
                                <path strokeLinecap="round" strokeLinejoin="round" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.5L15.232 5.232z" />
                              </svg>
                            </button>
                            
                            {/* Remove Button (now icon) */}
                            <button
                              onClick={() => setUserToConfirmRemove(user)}
                              className="text-gray-500 hover:text-red-600 focus:outline-none"
                              title="Remove user"
                            >
                              <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}>
                                <path strokeLinecap="round" strokeLinejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                              </svg>
                            </button>
                          </div>
                        </td>
                      </tr>
                    );
                  }) : (
                     <tr>
                      <td colSpan="8" className="px-6 py-4 text-center text-sm text-gray-500 italic">
                        No users found for this company.
                      </td>
                    </tr>
                  )}
                </tbody>
              </table>
            </div>
          </Card>

          {/* Report Generator Modal */}
          <ReportGeneratorModal
            isOpen={isReportModalOpen}
            onClose={() => setIsReportModalOpen(false)}
            company={company}
            users={usersForCompany}
            // licenses={licensesForCompany} // No longer needed
            addons={addons}
            userAddons={userAddons}
            isGenerating={isGenerating}
            setIsGenerating={setIsGenerating}
            generatedImage={generatedImage}
            setGeneratedImage={setGeneratedImage}
          />
          
          {/* UPDATED: Simplified AddModal */}
          <AddModal
            isOpen={isAddModalOpen}
            onClose={() => setIsAddModalOpen(false)}
            onAddUserWithLicense={handleAddNewUserWithLicense}
          />
          
          {/* Edit User Modal */}
          <EditUserModal
            isOpen={!!editingUser}
            onClose={() => setEditingUser(null)}
            user={editingUser}
            onSaveUser={handleSaveUser}
          />

          {/* Confirm Remove Modal */}
          <ConfirmRemoveModal
            isOpen={!!userToConfirmRemove}
            onClose={() => setUserToConfirmRemove(null)}
            user={userToConfirmRemove}
            onConfirmRemove={executeRemoveUser}
          />
          
          {/* Manage Addons Modal */}
          <ManageAddonsModal
            isOpen={!!managingUser}
            onClose={() => setManagingUser(null)}
            user={managingUser}
            addons={addons}
            userAddons={userAddons}
            setUserAddons={setUserAddons}
          />
        </>
      );
    }

    /**
     * Page 3: Shows a list of all users with search
     */
    function AllUsersPage({ users, companies, addons, userAddons, onSelectCompany }) {
      const [searchTerm, setSearchTerm] = useState('');
      const [sortConfig, setSortConfig] = useState({ key: 'name', direction: 'ascending' });
      const [copiedEmail, setCopiedEmail] = useState(null); // State for copy feedback

      // REMOVED: getLicenseForUser
      
      const getCompanyForUser = (companyId) => {
        return companies.find(c => c.id === companyId);
      };
      
      // Get addons for a specific user
      const getAddonsForUser = (userId) => {
        return userAddons
          .filter(ua => ua.userId === userId)
          .map(ua => addons.find(a => a.id === ua.addonId))
          .filter(Boolean); // Filter out any potential undefined
      };

      const filteredUsers = users.filter(user => {
        const lowerSearch = searchTerm.toLowerCase();
        const company = getCompanyForUser(user.companyId); 
        return (
          user.name.toLowerCase().includes(lowerSearch) ||
          user.email.toLowerCase().includes(lowerSearch) ||
          (company && company.name.toLowerCase().includes(lowerSearch))
        );
      });

      // UPDATED: Now considers company's on-hold status
      const getSortableStatus = (user, company) => {
        // "On Hold" status is the highest priority
        if (company?.onHold) return 0;
        
        if (!user || !user.licenseExpiry) return 4; 
        const daysLeft = (new Date(user.licenseExpiry) - new Date()) / (1000 * 60 * 60 * 24);
        if (daysLeft < 0) return 1; 
        if (daysLeft <= 14) return 2;
        return 3;
      };

      const requestSort = (key) => {
        let direction = 'ascending';
        if (sortConfig.key === key && sortConfig.direction === 'ascending') {
          direction = 'descending';
        }
        setSortConfig({ key, direction });
      };

      const sortedUsers = [...filteredUsers].sort((a, b) => {
        let aValue;
        let bValue;

        switch (sortConfig.key) {
          case 'name':
            aValue = a.name;
            bValue = b.name;
            break;
          case 'company':
            aValue = getCompanyForUser(a.companyId)?.name || '';
            bValue = getCompanyForUser(b.companyId)?.name || '';
            break;
          case 'status':
            // UPDATED: Pass user and company to get correct sort order
            const companyA = getCompanyForUser(a.companyId);
            const companyB = getCompanyForUser(b.companyId);
            aValue = getSortableStatus(a, companyA);
            bValue = getSortableStatus(b, companyB);
            break;
          case 'expires':
            aValue = a.licenseExpiry ? new Date(a.licenseExpiry) : new Date('9999-12-31');
            bValue = b.licenseExpiry ? new Date(b.licenseExpiry) : new Date('9999-12-31');
            break;
          default:
            aValue = a.name;
            bValue = b.name;
        }

        let comparison = 0;
        if (aValue > bValue) {
          comparison = 1;
        } else if (aValue < bValue) {
          comparison = -1;
        }

        return sortConfig.direction === 'ascending' ? comparison : -comparison;
      });

      const getSortIcon = (key) => {
        if (sortConfig.key !== key) {
          return null;
        }
        if (sortConfig.direction === 'ascending') {
          return ' \u25B2'; 
        }
        return ' \u25BC'; 
      };
      
      const handleCopyEmail = (email, event) => {
        event.stopPropagation();
        navigator.clipboard.writeText(email);
        setCopiedEmail(email);
        setTimeout(() => setCopiedEmail(null), 2000);
      };

      const handleEmailAll = () => {
        if (sortedUsers.length === 0) return;
        const bccList = sortedUsers.map(u => u.email).join(',');
        
        const gmailBaseUrl = 'https://mail.google.com/mail/?view=cm&fs=1&bcc=';
        const gmailLink = `${gmailBaseUrl}${encodeURIComponent(bccList)}`;

        // Most browsers have a URL limit around 2000 chars. Let's be safe.
        if (gmailLink.length > 2000) {
            alert('The list of users is too long to open in a single Gmail compose window. Please consider exporting the list and using a dedicated mailing tool.');
            return;
        }
        
        // Open in a new tab
        window.open(gmailLink, '_blank', 'noopener,noreferrer');
      };


      return (
        <Card title="All Users">
          {/* Search and Sort Controls */}
          <div className="flex flex-col md:flex-row gap-4 mb-4">
            <div className="relative flex-grow">
              <span className="absolute inset-y-0 left-0 flex items-center pl-3 text-gray-400">
                <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}>
                  <path strokeLinecap="round" strokeLinejoin="round" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                </svg>
              </span>
              <input
                type="text"
                value={searchTerm}
                onChange={(e) => setSearchTerm(e.target.value)}
                placeholder="Search by name, email, or company..."
                className="block w-full rounded-full border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm pl-10 pr-10 py-2"
              />
              {searchTerm && (
                <button
                  onClick={() => setSearchTerm('')}
                  className="absolute inset-y-0 right-0 flex items-center pr-2 focus:outline-none"
                  aria-label="Clear search"
                >
                  <div className="bg-gray-200 hover:bg-gray-300 rounded-full p-1 transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" className="h-4 w-4 text-gray-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}>
                      <path strokeLinecap="round" strokeLinejoin="round" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                  </div>
                </button>
              )}
            </div>
            {/* NEW: Email All Users Button */}
            <div className="flex-shrink-0">
                <button
                  onClick={handleEmailAll}
                  disabled={sortedUsers.length === 0}
                  className="w-full md:w-auto px-4 py-2 bg-green-600 text-white rounded-full shadow-sm hover:bg-green-700 transition-colors focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2 disabled:bg-gray-400 disabled:cursor-not-allowed"
                  title={sortedUsers.length > 0 ? `Compose an email to all ${sortedUsers.length} filtered users` : 'No users to email'}
                >
                  Email All Users
                </button>
            </div>
          </div>

          {/* Users Table */}
          <div className="overflow-x-auto">
            <table className="min-w-full divide-y divide-gray-200">
              <thead className="bg-gray-50">
                <tr>
                  <th 
                    className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100"
                    onClick={() => requestSort('name')}
                  >
                    Name{getSortIcon('name')}
                  </th>
                  <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Email</th>
                  <th 
                    className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100"
                    onClick={() => requestSort('company')}
                  >
                    Company{getSortIcon('company')}
                  </th>
                  <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">License Type</th>
                  {/* NEW: Addons Column */}
                  <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Addons</th>
                  <th 
                    className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100"
                    onClick={() => requestSort('status')}
                  >
                    Status{getSortIcon('status')}
                  </th>
                  <th 
                    className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100"
                    onClick={() => requestSort('expires')}
                  >
                    Expires{getSortIcon('expires')}
                  </th>
                </tr>
              </thead>
              <tbody className="bg-white divide-y divide-gray-200">
                {sortedUsers.map((user) => {
                  // const license = getLicenseForUser(user.id); // REMOVED
                  const company = getCompanyForUser(user.companyId);
                  const userAddonsList = getAddonsForUser(user.id);
                  return (
                    <tr key={user.id} className={company?.onHold ? 'bg-red-50' : ''}>
                      <td className="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">{user.name}</td>
                      {/* UPDATED: Interactive Email Cell */}
                      <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                          <div className="flex items-center space-x-2 group">
                              <a 
                                href={`https://mail.google.com/mail/?view=cm&fs=1&to=${user.email}`} 
                                target="_blank"
                                rel="noopener noreferrer"
                                className="hover:text-blue-600" 
                                title={`Email ${user.email} using Gmail`}
                              >
                                  {user.email}
                              </a>
                              <div className="relative">
                                  <button
                                      onClick={(e) => handleCopyEmail(user.email, e)}
                                      className="text-gray-400 hover:text-gray-700 opacity-0 group-hover:opacity-100 focus:opacity-100 transition-opacity"
                                      aria-label="Copy email address"
                                  >
                                      <svg xmlns="http://www.w3.org/2000/svg" className="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}>
                                          <path strokeLinecap="round" strokeLinejoin="round" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" />
                                      </svg>
                                  </button>
                                  {copiedEmail === user.email && (
                                      <div className="absolute z-10 -top-8 left-1/2 -translate-x-1/2 px-2 py-1 bg-gray-800 text-white text-xs rounded-md shadow-lg">
                                          Copied!
                                      </div>
                                  )}
                              </div>
                          </div>
                      </td>
                      <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                        {company ? (
                          <button
                            onClick={() => onSelectCompany(company.id)}
                            className="hover:text-blue-600 hover:underline focus:outline-none focus:underline"
                            title={`View details for ${company.name}`}
                          >
                            {company.name}
                          </button>
                        ) : (
                          'N/A'
                        )}
                      </td>
                      <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                        {user.licenseType ? (
                          <span className="px-3 py-1 inline-flex text-xs leading-5 font-semibold rounded-full bg-gray-100 text-gray-800">
                            {user.licenseType}
                          </span>
                        ) : (
                          <span className="text-gray-400 italic">N/A</span>
                        )}
                      </td>
                      {/* NEW: Addons Cell */}
                      <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                        {userAddonsList.length > 0 ? (
                           userAddonsList.map(a => a.name).join(', ')
                        ) : (
                          <span className="text-gray-400 italic">N/A</span>
                        )}
                      </td>
                      <td className="px-6 py-4 whitespace-nowrap text-sm">
                        {/* UPDATED: Pass company to get correct status */}
                        {getStatusChip(user.licenseExpiry, company)}
                      </td>
                      <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{formatDate(user.licenseExpiry)}</td>
                    </tr>
                  );
                })}
              </tbody>
            </table>
          </div>
        </Card>
      );
    }

    // --- Generic Modal Component ---
    function Modal({ isOpen, onClose, title, children, widthClass = 'max-w-lg' }) {
      if (!isOpen) return null;

      return (
        <div
          className="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50"
          onClick={onClose}
        >
          <div
            className={`bg-white rounded-lg shadow-xl m-4 ${widthClass} w-full`}
            onClick={(e) => e.stopPropagation()} 
          >
            <div className="flex justify-between items-center p-4 border-b">
              <h3 className="text-xl font-semibold text-gray-900">{title}</h3>
              <button
                onClick={onClose}
                className="text-gray-400 hover:text-gray-600 focus:outline-none"
              >
                <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}>
                  <path strokeLinecap="round" strokeLinejoin="round" d="M6 18L18 6M6 6l12 12" />
                </svg>
              </button>
            </div>
            {/* Children are now rendered *without* a p-6, so modal content can control its own padding */}
            {children}
          </div>
        </div>
      );
    }

    // --- Report Generator Modal Component ---
    function ReportGeneratorModal({
      isOpen,
      onClose,
      company,
      users, // This is usersForCompany
      // REMOVED: licenses
      addons, // Get all addons
      userAddons, // Get user addon assignments
      isGenerating,
      setIsGenerating,
      generatedImage,
      setGeneratedImage,
    }) {
      const reportRef = useRef(null);
      
      // REMOVED: getLicenseForUser
      // REMOVED: availableLicenses
      
      // Get addons for a specific user for the report
      const getAddonsForUserReport = (userId) => {
        return userAddons
          .filter(ua => ua.userId === userId)
          .map(ua => addons.find(a => a.id === ua.addonId))
          .filter(Boolean)
          .map(a => a.name)
          .join(', ');
      };

      useEffect(() => {
        if (isOpen && isGenerating && reportRef.current && typeof html2canvas === 'function') {
          html2canvas(reportRef.current, {
            scale: 2, 
            useCORS: true,
            backgroundColor: '#ffffff',
          }).then(canvas => {
            setGeneratedImage(canvas.toDataURL('image/png'));
            setIsGenerating(false);
          }).catch(err => {
            console.error("Error generating canvas:", err);
            setIsGenerating(false);
          });
        } else if (isOpen && isGenerating && typeof html2canvas !== 'function') {
          console.warn("html2canvas not loaded yet, retrying...");
          setTimeout(() => {
            setIsGenerating(false); 
            setTimeout(() => setIsGenerating(true), 50);
          }, 500);
        }
      }, [isOpen, isGenerating, reportRef, setGeneratedImage, setIsGenerating]);

      useEffect(() => {
        if (!isOpen) {
          setGeneratedImage(null);
          setIsGenerating(false);
        }
      }, [isOpen, setGeneratedImage, setIsGenerating]);

      return (
        <Modal isOpen={isOpen} onClose={onClose} title="License Report" widthClass="max-w-4xl">
          <div className="p-6">
            {isGenerating && (
              <div className="text-center p-8">
                <p className="text-lg font-medium text-gray-700">Generating report image...</p>
                <p className="text-sm text-gray-500">This may take a moment.</p>
              </div>
            )}
            {!isGenerating && generatedImage && (
              <div>
                <h3 className="text-lg font-semibold text-gray-900 mb-2">Report Generated</h3>
                <p className="text-sm text-gray-600 mb-4">
                  You can now <strong>right-click</strong> the image below to copy it and paste it into your email.
                </p>
                <div className="overflow-auto border border-gray-300 rounded-lg">
                  <img
                    src={generatedImage}
                    alt="License Report"
                    className="w-full"
                  />
                </div>
              </div>
            )}
          </div>
          
          {/* This div is rendered hidden but available for html2canvas */}
          <div 
            className="absolute -left-[9999px] top-0 p-6 bg-white"
            style={{ width: '800px', fontFamily: 'sans-serif', color: 'black' }} // Increased width for new column
            ref={reportRef}
          >
            <h2 style={{ fontSize: '24px', fontWeight: '600', marginBottom: '4px' }}>
              EFD License Report
            </h2>
            <h3 style={{ fontSize: '18px', fontWeight: '500', marginBottom: '16px', color: '#374151' }}>
              {company.name}
            </h3>
            
            {/* UPDATED: Renamed first table */}
            <h4 style={{ fontSize: '16px', fontWeight: '600', marginBottom: '8px', color: '#111827' }}>
              Users & Assigned Licenses
            </h4>
            <table style={{ width: '100%', borderCollapse: 'collapse' }}>
              <thead style={{ backgroundColor: '#F9FAFB' }}>
                <tr>
                  <th style={{ padding: '8px 12px', border: '1px solid #E5E7EB', textAlign: 'left', fontSize: '12px', color: '#374151' }}>Name</th>
                  <th style={{ padding: '8px 12px', border: '1px solid #E5E7EB', textAlign: 'left', fontSize: '12px', color: '#374151' }}>License Type</th>
                  {/* Addons Column */}
                  <th style={{ padding: '8px 12px', border: '1px solid #E5E7EB', textAlign: 'left', fontSize: '12px', color: '#374151' }}>Addons</th>
                  <th style={{ padding: '8px 12px', border: '1px solid #E5E7EB', textAlign: 'left', fontSize: '12px', color: '#374151' }}>Status</th>
                  <th style={{ padding: '8px 12px', border: '1px solid #E5E7EB', textAlign: 'left', fontSize: '12px', color: '#374151' }}>Expiry Date</th>
                </tr>
              </thead>
              <tbody>
                {users.map(user => { 
                  // const license = getLicenseForUser(user.id); // REMOVED
                  const addonsList = getAddonsForUserReport(user.id); // NEW
                  const status = getStatusText(user.licenseExpiry, company); // UPDATED to pass company
                  let statusColor = '#374151'; 
                  if (status === 'On Hold') statusColor = '#5B21B6';
                  if (status === 'Expired') statusColor = '#991B1B';
                  if (status === 'Expires Soon') statusColor = '#9A3412';
                  
                  return (
                    <tr key={user.id} style={{ borderBottom: '1px solid #F3F4F6' }}>
                      <td style={{ padding: '8px 12px', fontSize: '14px', fontWeight: '500' }}>{user.name}</td>
                      <td style={{ padding: '8px 12px', fontSize: '14px', color: '#374151' }}>{user.licenseType || 'N/A'}</td>
                      {/* Addons Cell */}
                      <td style={{ padding: '8px 12px', fontSize: '14px', color: '#374151' }}>{addonsList || 'N/A'}</td>
                      <td style={{ padding: '8px 12px', fontSize: '14px', fontWeight: '500', color: statusColor }}>{status}</td>
                      <td style={{ padding: '8px 12px', fontSize: '14px', color: '#374151' }}>{formatDate(user.licenseExpiry)}</td>
                    </tr>
                  );
                })}
              </tbody>
            </table>
            
            {/* --- REMOVED: Available Licenses Table for Report --- */}
          </div>
        </Modal>
      );
    }

    // --- NEW: Add Company Modal ---
    function AddCompanyModal({ isOpen, onClose, onAddCompany }) {
      const [name, setName] = useState('');

      const handleSubmit = (e) => {
        e.preventDefault();
        if (name) {
          onAddCompany(name);
          setName(''); // Reset form
        }
      };

      return (
        <Modal isOpen={isOpen} onClose={onClose} title="Add New Company">
          <form onSubmit={handleSubmit} className="space-y-4 p-6">
            <div>
              <label htmlFor="company-name" className="block text-sm font-medium text-gray-700">
                Company Name
              </label>
              <input
                type="text"
                id="company-name"
                value={name}
                onChange={(e) => setName(e.target.value)}
                required
                className="mt-1 block w-full rounded-md border border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm py-2 px-3"
              />
            </div>
            <div className="flex justify-end gap-2 pt-4">
              <button
                type="button"
                onClick={onClose}
                className="px-4 py-2 bg-gray-200 text-gray-800 rounded-md shadow-sm hover:bg-gray-300 transition-colors focus:outline-none focus:ring-2 focus:ring-gray-400 focus:ring-offset-2"
              >
                Cancel
              </button>
              <button
                type="submit"
                className="px-4 py-2 bg-blue-600 text-white rounded-md shadow-sm hover:bg-blue-700 transition-colors focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2"
              >
                Save Company
              </button>
            </div>
          </form>
        </Modal>
      );
    }


    // --- UPDATED: Simplified Add Modal ---
    function AddModal({ isOpen, onClose, onAddUserWithLicense }) {
      // Form state for new user
      const [name, setName] = useState('');
      const [email, setEmail] = useState('');
      const [userLicenseType, setUserLicenseType] = useState('Individual');
      // UPDATED: Default expiry date is now 1 month from today
      const [userExpiry, setUserExpiry] = useState(getOneMonthFromToday());

      const handleAddUserSubmit = (e) => {
        e.preventDefault();
        if (name && email && userLicenseType && userExpiry) {
          onAddUserWithLicense({ name, email, type: userLicenseType, expiry: userExpiry });
          // Reset form
          setName('');
          setEmail('');
          setUserLicenseType('Individual');
          // UPDATED: Reset expiry date to the default
          setUserExpiry(getOneMonthFromToday());
        }
      };
      
      // When modal opens, reset the date to default
      useEffect(() => {
        if (isOpen) {
          setUserExpiry(getOneMonthFromToday());
        }
      }, [isOpen]);

      return (
        <Modal isOpen={isOpen} onClose={onClose} title="Add New User & License">
          {/* Content */}
          <div className="p-6">
            <form onSubmit={handleAddUserSubmit} className="space-y-4">
              <h3 className="text-lg font-medium text-gray-900">User Details</h3>
              <div>
                <label htmlFor="name" className="block text-sm font-medium text-gray-700">
                  Full Name
                </label>
                <input
                  type="text"
                  id="name"
                  value={name}
                  onChange={(e) => setName(e.target.value)}
                  required
                  className="mt-1 block w-full rounded-md border border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm py-2 px-3"
                />
              </div>
              <div>
                <label htmlFor="email" className="block text-sm font-medium text-gray-700">
                  Email Address
                </label>
                <input
                  type="email"
                  id="email"
                  value={email}
                  onChange={(e) => setEmail(e.target.value)}
                  required
                  className="mt-1 block w-full rounded-md border border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm py-2 px-3"
                />
              </div>
              
              <h3 className="text-lg font-medium text-gray-900 pt-2 border-t">License Details</h3>
              <p className="text-sm text-gray-500">Create and assign this user's first license.</p>
              <div>
                <label htmlFor="user-license-type" className="block text-sm font-medium text-gray-700">
                  License Type
                </label>
                <select
                  id="user-license-type"
                  value={userLicenseType}
                  onChange={(e) => setUserLicenseType(e.target.value)}
                  className="mt-1 block w-full rounded-md border border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm py-2"
                >
                  <option>Individual</option>
                  <option>Shared</option>
                </select>
              </div>
              <div>
                <label htmlFor="user-expiry-date" className="block text-sm font-medium text-gray-700">
                  Expiry Date
                </label>
                <input
                  type="date"
                  id="user-expiry-date"
                  value={userExpiry}
                  onChange={(e) => setUserExpiry(e.target.value)}
                  required
                  className="mt-1 block w-full rounded-md border border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm py-2"
                />
              </div>
              
              <div className="flex justify-end gap-2 pt-4">
                <button
                  type="button"
                  onClick={onClose}
                  className="px-4 py-2 bg-gray-200 text-gray-800 rounded-md shadow-sm hover:bg-gray-300 transition-colors focus:outline-none focus:ring-2 focus:ring-gray-400 focus:ring-offset-2"
                >
                  Cancel
                </button>
                <button
                  type="submit"
                  className="px-4 py-2 bg-blue-600 text-white rounded-md shadow-sm hover:bg-blue-700 transition-colors focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2"
                >
                  Save User & License
                </button>
              </div>
            </form>
          </div>
        </Modal>
      );
    }


    // --- Edit User Modal Component ---
    function EditUserModal({ isOpen, onClose, user, onSaveUser }) {
      const [name, setName] = useState('');
      const [email, setEmail] = useState('');

      // When the modal opens (when `user` prop changes), fill the form
      useEffect(() => {
        if (user) {
          setName(user.name);
          setEmail(user.email);
        }
      }, [user]);

      const handleSubmit = (e) => {
        e.preventDefault();
        if (name && email) {
          onSaveUser({
            ...user, // Keep the id and companyId
            name,
            email,
          });
        }
      };

      return (
        <Modal isOpen={isOpen} onClose={onClose} title={`Edit User: ${user?.name || ''}`}>
          <form onSubmit={handleSubmit} className="space-y-4 p-6">
            <div>
              <label htmlFor="edit-name" className="block text-sm font-medium text-gray-700">
                Full Name
              </label>
              <input
                type="text"
                id="edit-name"
                value={name}
                onChange={(e) => setName(e.target.value)}
                required
                className="mt-1 block w-full rounded-md border border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm py-2 px-3"
              />
            </div>
            <div>
              <label htmlFor="edit-email" className="block text-sm font-medium text-gray-700">
                Email Address
              </label>
              <input
                type="email"
                id="edit-email"
                value={email}
                onChange={(e) => setEmail(e.target.value)}
                required
                className="mt-1 block w-full rounded-md border border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm py-2 px-3"
              />
            </div>
            <div className="flex justify-end gap-2 pt-4">
              <button
                type="button"
                onClick={onClose}
                className="px-4 py-2 bg-gray-200 text-gray-800 rounded-md shadow-sm hover:bg-gray-300 transition-colors focus:outline-none focus:ring-2 focus:ring-gray-400 focus:ring-offset-2"
              >
                Cancel
              </button>
              <button
                type="submit"
                className="px-4 py-2 bg-blue-600 text-white rounded-md shadow-sm hover:bg-blue-700 transition-colors focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2"
              >
                Save Changes
              </button>
            </div>
          </form>
        </Modal>
      );
    }


    // --- Confirm Remove Modal Component ---
    function ConfirmRemoveModal({ isOpen, onClose, user, onConfirmRemove }) {
      if (!user) return null;

      return (
        <Modal isOpen={isOpen} onClose={onClose} title="Confirm Removal">
          <div className="space-y-4 p-6">
            <p className="text-sm text-gray-700">
              Are you sure you want to remove <span className="font-semibold">{user.name}</span>?
            </p>
            <p className="text-sm text-gray-600">
              This will also remove their license and all their addons. This action cannot be undone.
            </p>
            <div className="flex justify-end gap-2 pt-4">
              <button
                type="button"
                onClick={onClose}
                className="px-4 py-2 bg-gray-200 text-gray-800 rounded-md shadow-sm hover:bg-gray-300 transition-colors focus:outline-none focus:ring-2 focus:ring-gray-400 focus:ring-offset-2"
              >
                Cancel
              </button>
              <button
                type="button"
                onClick={() => onConfirmRemove(user.id)}
                className="px-4 py-2 bg-red-600 text-white rounded-md shadow-sm hover:bg-red-700 transition-colors focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2"
              >
                Confirm Remove
              </button>
            </div>
          </div>
        </Modal>
      );
    }

    // --- NEW: Confirm Remove Company Modal Component ---
    function ConfirmRemoveCompanyModal({ isOpen, onClose, company, onConfirmRemove }) {
      if (!company) return null;

      return (
        <Modal isOpen={isOpen} onClose={onClose} title="Confirm Company Removal">
          <div className="space-y-4 p-6">
            <p className="text-sm text-gray-700">
              Are you sure you want to remove <span className="font-semibold">{company.name}</span>?
            </p>
            <p className="text-sm text-gray-600">
              This will also delete all associated users and their license data. This action cannot be undone.
            </p>
            <div className="flex justify-end gap-2 pt-4">
              <button
                type="button"
                onClick={onClose}
                className="px-4 py-2 bg-gray-200 text-gray-800 rounded-md shadow-sm hover:bg-gray-300 transition-colors focus:outline-none focus:ring-2 focus:ring-gray-400 focus:ring-offset-2"
              >
                Cancel
              </button>
              <button
                type="button"
                onClick={() => onConfirmRemove(company.id)}
                className="px-4 py-2 bg-red-600 text-white rounded-md shadow-sm hover:bg-red-700 transition-colors focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2"
              >
                Confirm Remove
              </button>
            </div>
          </div>
        </Modal>
      );
    }

    // --- Manage Addons Modal Component ---
    function ManageAddonsModal({ isOpen, onClose, user, addons, userAddons, setUserAddons }) {
      // Local state to track checkbox changes
      const [selectedAddonIds, setSelectedAddonIds] = useState(new Set());

      // When the modal opens, populate the local state with the user's current addons
      useEffect(() => {
        if (user) {
          const currentAddonIds = userAddons
            .filter(ua => ua.userId === user.id)
            .map(ua => ua.addonId);
          setSelectedAddonIds(new Set(currentAddonIds));
        }
      }, [isOpen, user, userAddons]);
      
      if (!user) return null;

      const handleCheckboxChange = (addonId, isChecked) => {
        setSelectedAddonIds(prev => {
          const newSet = new Set(prev);
          if (isChecked) {
            newSet.add(addonId);
          } else {
            newSet.delete(addonId);
          }
          return newSet;
        });
      };

      const handleSave = () => {
        const newAddonIds = Array.from(selectedAddonIds);
        
        // MOCK: Update local state directly
        const newUserAddonAssignments = newAddonIds.map(addonId => ({
            id: Date.now() + addonId, // mock unique id
            userId: user.id,
            addonId: addonId
        }));
        
        setUserAddons(prev => [
            // Filter out old assignments for this user
            ...prev.filter(ua => ua.userId !== user.id),
            // Add the new assignments
            ...newUserAddonAssignments
        ]);
        onClose(); // Close the modal
      };

      return (
        <Modal isOpen={isOpen} onClose={onClose} title={`Manage Addons for ${user.name}`}>
          <div className="space-y-4 p-6">
            <p className="text-sm text-gray-600">Select the addons to assign to this user.</p>
            <fieldset className="space-y-2">
              {addons.length > 0 ? (
                addons.map(addon => {
                  const isChecked = selectedAddonIds.has(addon.id);
                  return (
                    <div key={addon.id} className="relative flex items-start">
                      <div className="flex h-5 items-center">
                        <input
                          id={`addon-${addon.id}`}
                          name="addons"
                          type="checkbox"
                          checked={isChecked}
                          onChange={(e) => handleCheckboxChange(addon.id, e.target.checked)}
                          className="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500"
                        />
                      </div>
                      <div className="ml-3 text-sm">
                        <label htmlFor={`addon-${addon.id}`} className="font-medium text-gray-700">
                          {addon.name}
                        </label>
                      </div>
                    </div>
                  );
                })
              ) : (
                 <p className="text-sm text-gray-500 italic text-center p-4">No addons have been created yet.</p>
              )}
            </fieldset>
            
            <div className="flex justify-end gap-2 pt-4">
              <button
                type="button"
                onClick={onClose}
                className="px-4 py-2 bg-gray-200 text-gray-800 rounded-md shadow-sm hover:bg-gray-300 transition-colors focus:outline-none focus:ring-2 focus:ring-gray-400 focus:ring-offset-2"
              >
                Cancel
              </button>
              <button
                type="button"
                onClick={handleSave}
                className="px-4 py-2 bg-blue-600 text-white rounded-md shadow-sm hover:bg-blue-700 transition-colors focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2"
              >
                Save Changes
              </button>
            </div>
          </div>
        </Modal>
      );
    }

    // --- UPDATED: Manage Addons List Modal Component ---
    function ManageAddonsListModal({ isOpen, onClose, addons, setAddons, userAddons, setUserAddons }) {
      const [newAddonName, setNewAddonName] = useState('');
      
      // NEW: State for editing an addon
      const [editingAddonId, setEditingAddonId] = useState(null);
      const [editingAddonName, setEditingAddonName] = useState('');
      const editInputRef = useRef(null);

      const handleAddAddon = (e) => {
        e.preventDefault();
        if (!newAddonName.trim()) return;
        
        const newAddon = {
            id: Date.now(),
            name: newAddonName.trim()
        };
        setAddons(prev => [...prev, newAddon]);
        setNewAddonName('');
      };

      const handleRemoveAddon = (addonIdToRemove) => {
        setAddons(prev => prev.filter(a => a.id !== addonIdToRemove));
        setUserAddons(prev => prev.filter(ua => ua.addonId !== addonIdToRemove));
      };

      // NEW: Handlers for editing
      const handleStartEdit = (addon) => {
        setEditingAddonId(addon.id);
        setEditingAddonName(addon.name);
      };

      const handleCancelEdit = () => {
        setEditingAddonId(null);
        setEditingAddonName('');
      };

      const handleSaveEdit = () => {
        if (!editingAddonName.trim()) return;
        
        setAddons(prevAddons =>
          prevAddons.map(a =>
            a.id === editingAddonId ? { ...a, name: editingAddonName.trim() } : a
          )
        );
        handleCancelEdit(); // Reset state
      };
      
      // NEW: Effect to focus the input when editing starts
      useEffect(() => {
        if (editingAddonId !== null && editInputRef.current) {
          editInputRef.current.focus();
        }
      }, [editingAddonId]);
      
      // NEW: Effect to cancel edit when modal closes
      useEffect(() => {
        if (!isOpen) {
            handleCancelEdit();
        }
      }, [isOpen]);

      return (
        <Modal isOpen={isOpen} onClose={onClose} title="Manage Global Addons">
          <div className="space-y-4 p-6">
            <h4 className="text-lg font-medium text-gray-900">Existing Addons</h4>
            <div className="max-h-60 overflow-y-auto border rounded-md p-2 space-y-2">
              {addons.length > 0 ? (
                addons.map(addon => {
                  const isAddonInUse = userAddons.some(ua => ua.addonId === addon.id);
                  const isEditingThis = editingAddonId === addon.id;
                  
                  return (
                    <div key={addon.id} className="flex justify-between items-center p-2 bg-gray-50 rounded min-h-[44px]">
                      {isEditingThis ? (
                        <div className="flex-grow flex items-center gap-2">
                          <input
                            ref={editInputRef}
                            type="text"
                            value={editingAddonName}
                            onChange={(e) => setEditingAddonName(e.target.value)}
                            onKeyDown={(e) => { if (e.key === 'Enter') handleSaveEdit(); if (e.key === 'Escape') handleCancelEdit(); }}
                            className="block w-full rounded-md border border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm py-1 px-2"
                          />
                          <button onClick={handleSaveEdit} className="text-sm text-blue-600 hover:text-blue-800 font-medium flex-shrink-0">Save</button>
                          <button onClick={handleCancelEdit} className="text-sm text-gray-600 hover:text-gray-800 flex-shrink-0">Cancel</button>
                        </div>
                      ) : (
                        <>
                          <span className="text-sm font-medium text-gray-800">{addon.name}</span>
                          <div className="flex items-center space-x-3">
                            <button
                              onClick={() => handleStartEdit(addon)}
                              disabled={editingAddonId !== null}
                              className="text-sm font-medium text-blue-600 hover:text-blue-800 disabled:text-gray-400 disabled:cursor-not-allowed"
                            >
                              Edit
                            </button>
                            {/* Wrapper for tooltip on disabled button */}
                            <span title={isAddonInUse ? "Cannot remove: addon is in use by one or more users." : ""}>
                              <button
                                onClick={() => handleRemoveAddon(addon.id)}
                                disabled={isAddonInUse || editingAddonId !== null}
                                className="text-sm font-medium text-red-600 hover:text-red-800 disabled:text-gray-400 disabled:cursor-not-allowed"
                                style={isAddonInUse || editingAddonId !== null ? { pointerEvents: 'none' } : {}}
                              >
                                Remove
                              </button>
                            </span>
                          </div>
                        </>
                      )}
                    </div>
                  );
                })
              ) : (
                <p className="text-sm text-gray-500 italic text-center p-4">No addons created yet.</p>
              )}
            </div>
            
            <form onSubmit={handleAddAddon} className="space-y-4 pt-4 border-t">
              <h4 className="text-lg font-medium text-gray-900">Add New Addon</h4>
              <div>
                <label htmlFor="addon-name" className="block text-sm font-medium text-gray-700">
                  Addon Name
                </label>
                <input
                  type="text"
                  id="addon-name"
                  value={newAddonName}
                  onChange={(e) => setNewAddonName(e.target.value)}
                  required
                  className="mt-1 block w-full rounded-md border border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm py-2 px-3"
                  placeholder="e.g., Premium Rendering Pack"
                />
              </div>
              <div className="flex justify-end gap-2">
                <button
                  type="button"
                  onClick={onClose}
                  className="px-4 py-2 bg-gray-200 text-gray-800 rounded-md shadow-sm hover:bg-gray-300 transition-colors focus:outline-none focus:ring-2 focus:ring-gray-400 focus:ring-offset-2"
                >
                  Close
                </button>
                <button
                  type="submit"
                  className="px-4 py-2 bg-blue-600 text-white rounded-md shadow-sm hover:bg-blue-700 transition-colors focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2"
                >
                  Add Addon
                </button>
              </div>
            </form>
          </div>
        </Modal>
      );
    }


    /**
     * Main Application Component
     */
    function App() {
      // UPDATED: All state now starts empty, will be populated by API
      const [companies, setCompanies] = useState([]);
      const [users, setUsers] = useState([]);
      const [addons, setAddons] = useState([]);
      const [userAddons, setUserAddons] = useState([]);
      
      const [view, setView] = useState('companies'); // 'companies' or 'users'
      const [selectedCompanyId, setSelectedCompanyId] = useState(null);
      
      // State for the global addon manager modal
      const [isManageAddonsModalOpen, setIsManageAddonsModalOpen] = useState(false);
      
      // NEW: State for loading and errors
      const [isLoading, setIsLoading] = useState(true);
      const [error, setError] = useState(null);
      
      // MOCK: Set to true to bypass login in preview
      const [isLoggedIn, setIsLoggedIn] = useState(true);
      
      const fetchData = () => {
        setIsLoading(true);
        setError(null);
        // MOCK: Simulate API call with mock data
        setTimeout(() => {
            try {
                setCompanies(mockData.companies);
                setUsers(mockData.users);
                setAddons(mockData.addons);
                setUserAddons(mockData.userAddons);
                setIsLoggedIn(true);
                setIsLoading(false);
            } catch (error) {
                setError(`Failed to load mock data. (Error: ${error.message})`);
                setIsLoading(false);
            }
        }, 500); // 0.5 second delay to simulate network
      };

      // Load the html2canvas script and fetch initial data
      useEffect(() => {
        // html2canvas script is loaded by <script> tag in <head>
        fetchData(); // Call the fetch function
      }, []); // Empty array means this runs once on mount

      const handleSelectCompany = (id) => {
        setSelectedCompanyId(id);
      };

      const handleClearCompany = () => {
        setSelectedCompanyId(null);
      };
      
      const handleLogout = () => {
        // MOCK: Just update state
        setIsLoggedIn(false);
      };

      const selectedCompany = companies.find(c => c.id === selectedCompanyId);
      
      // UPDATED: Totals are now based on users array
      const totalLicenses = users.length;
      const totalIndividual = users.filter(u => u.licenseType === 'Individual').length;
      const totalShared = users.filter(u => u.licenseType === 'Shared').length;

      // NEW: Render Login Screen if not logged in
      if (!isLoggedIn && !isLoading) {
        return <LoginScreen onLoginSuccess={() => {
          setIsLoggedIn(true);
          fetchData(); // Refetch data on successful login
        }} />;
      }

      return (
        <div className="bg-gray-100 min-h-screen p-4 md:p-8 font-sans">
          <div className="max-w-7xl mx-auto">
            
            {/* UPDATED Header */}
            <header className="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
              <h1 className="text-4xl font-bold text-gray-800">EFD License Manager</h1>
              <div className="flex gap-2">
                <button
                  onClick={() => setIsManageAddonsModalOpen(true)}
                  className="px-4 py-2 bg-gray-600 text-white rounded-md shadow-sm hover:bg-gray-700 transition-colors focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2"
                >
                  Manage Addons
                </button>
                <button
                  onClick={handleLogout}
                  className="px-4 py-2 bg-red-600 text-white rounded-md shadow-sm hover:bg-red-700 transition-colors focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2"
                >
                  Logout
                </button>
              </div>
            </header>
            
            {/* NEW: Loading and Error states */}
            {isLoading && (
              <div className="text-center p-12">
                <div className="w-16 h-16 border-4 border-blue-600 border-dashed rounded-full animate-spin mx-auto" role="status">
                  <span className="sr-only">Loading...</span>
                </div>
                <p className="text-lg font-medium text-gray-600 mt-4">Loading data...</p>
              </div>
            )}
            
            {error && (
              <div className="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg relative" role="alert">
                <strong className="font-bold">Error:</strong>
                <span className="block sm:inline"> {error}</span>
              </div>
            )}

            {!isLoading && !error && selectedCompanyId ? (
              <CompanyDetailPage
                company={selectedCompany}
                users={users}
                setUsers={setUsers}
                addons={addons}
                userAddons={userAddons}
                setUserAddons={setUserAddons}
                onBack={handleClearCompany}
              />
            ) : !isLoading && !error && (
              <>
                <div className="mb-4">
                  <nav className="flex space-x-4 border-b border-gray-300">
                    <button
                      onClick={() => setView('companies')}
                      className={`py-2 px-4 text-sm font-medium ${
                        view === 'companies'
                          ? 'border-b-2 border-blue-600 text-blue-600'
                          : 'text-gray-500 hover:text-gray-700'
                      } focus:outline-none`}
                    >
                      Companies
                    </button>
                    <button
                      onClick={() => setView('users')}
                      className={`py-2 px-4 text-sm font-medium ${
                        view === 'users'
                          ? 'border-b-2 border-blue-600 text-blue-600'
                          : 'text-gray-500 hover:text-gray-700'
                      } focus:outline-none`}
                    >
                      All Users
                    </button>
                  </nav>
                </div>

                <main>
                  {view === 'companies' && (
                    <CompaniesListPage
                      companies={companies}
                      setCompanies={setCompanies} 
                      users={users}
                      setUsers={setUsers}
                      setUserAddons={setUserAddons}
                      onSelectCompany={handleSelectCompany}
                      totalLicenses={totalLicenses} 
                      totalIndividual={totalIndividual}
                      totalShared={totalShared}
                    />
                  )}
                  {view === 'users' && (
                    <AllUsersPage
                      users={users}
                      companies={companies}
                      addons={addons}
                      userAddons={userAddons}
                      onSelectCompany={handleSelectCompany}
                    />
                  )}
                </main>
              </>
            )}
            
            {/* Manage Addons Modal */}
            <ManageAddonsListModal
              isOpen={isManageAddonsModalOpen}
              onClose={() => setIsManageAddonsModalOpen(false)}
              addons={addons}
              setAddons={setAddons}
              userAddons={userAddons}
              setUserAddons={setUserAddons}
            />
            
          </div>
        </div>
      );
    }
    
    // --- NEW: Login Screen Component ---
    function LoginScreen({ onLoginSuccess }) {
      const [username, setUsername] = useState('');
      const [password, setPassword] = useState('');
      const [error, setError] = useState(null);
      const [isLoading, setIsLoading] = useState(false);
      
      const handleSubmit = (e) => {
        e.preventDefault();
        setError(null);
        setIsLoading(true);
        
        // MOCK: Simulate a successful login for development
        setTimeout(() => {
            if (username && password) {
                onLoginSuccess();
            } else {
                setError('Please enter a username and password.');
            }
            setIsLoading(false);
        }, 500);
      };
      
      return (
        <div className="min-h-screen flex items-center justify-center bg-gray-100">
          <div className="max-w-md w-full bg-white shadow-lg rounded-xl p-8">
            <h2 className="text-3xl font-bold text-center text-gray-900 mb-6">
              EFD License Manager
            </h2>
            <form className="space-y-6" onSubmit={handleSubmit}>
              {error && (
                <div className="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg" role="alert">
                  <p>{error}</p>
                </div>
              )}
              <div>
                <label htmlFor="username" className="block text-sm font-medium text-gray-700">
                  Username
                </label>
                <div className="mt-1">
                  <input
                    id="username"
                    name="username"
                    type="text"
                    required
                    value={username}
                    onChange={(e) => setUsername(e.target.value)}
                    className="block w-full rounded-md border border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm py-2 px-3"
                  />
                </div>
              </div>

              <div>
                <label htmlFor="password" className="block text-sm font-medium text-gray-700">
                  Password
                </label>
                <div className="mt-1">
                  <input
                    id="password"
                    name="password"
                    type="password"
                    required
                    value={password}
                    onChange={(e) => setPassword(e.target.value)}
                    className="block w-full rounded-md border border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm py-2 px-3"
                  />
                </div>
              </div>

              <div>
                <button
                  type="submit"
                  disabled={isLoading}
                  className="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 disabled:bg-gray-400"
                >
                  {isLoading ? 'Logging in...' : 'Log in'}
                </button>
              </div>
            </form>
          </div>
        </div>
      );
    }


    // 5. Find the root DOM node and render the App
    const container = document.getElementById('root');
    const root = ReactDOM.createRoot(container);
    root.render(<App />);

  </script>
</body>
</html>
